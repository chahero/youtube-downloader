<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Downloader</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="app-header">
            üé• YouTube Downloader
            <div class="user-status">
                <span>Welcome, {{ username if username else 'User' }}</span> 
                <a href="{{ url_for('logout') }}">Logout</a>
            </div>
        </div>
        
        <div class="input-section">
            <input type="text" id="url" placeholder="Enter YouTube URL or Playlist URL">
            
            <div class="options-row">
                <div class="option-group">
                    <label for="quality">Quality:</label>
                    <select id="quality">
                        <option value="best">Best</option>
                        <option value="2160p">2160p (4K)</option>
                        <option value="1440p">1440p (2K)</option>
                        <option value="1080p" selected>1080p (Full HD)</option>
                        <option value="720p">720p (HD)</option>
                        <option value="480p">480p</option>
                        <option value="360p">360p</option>
                    </select>
                </div>
                
                <div class="option-group">
                    <label for="format">Format:</label>
                    <select id="format">
                        <option value="video">Video (MP4)</option>
                        <option value="audio_mp3">Audio Only (MP3)</option>
                        <option value="audio_m4a">Audio Only (M4A)</option>
                    </select>
                </div>
                
                <div class="option-group">
                    <label for="notifications">
                        <input type="checkbox" id="notifications" checked> 
                        <span class="checkbox-label">Notifications</span>
                    </label>
                </div>
            </div>
            
            <button onclick="startDownload()">Start Download</button>
        </div>
        
        <div class="info">
            <span>Concurrent Downloads: <span id="activeCount">0</span> / {{ max_downloads }}</span>
            <div class="info-buttons">
                <button class="clear-inactive-btn" onclick="clearInactive()">üóëÔ∏è Clear Inactive</button>
                <button class="clean-storage-btn" onclick="cleanStorage()">üóëÔ∏è Clean Storage</button>
            </div>
        </div>
        
        <div id="downloads"></div>
    </div>

    <script>
        let checkIntervals = {};
        let playlistIntervals = {};
        let notificationsEnabled = true;

        // ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // ÏïåÎ¶º Ï≤¥ÌÅ¨Î∞ïÏä§ Î≥ÄÍ≤Ω Ïãú
        document.getElementById('notifications').addEventListener('change', function() {
            notificationsEnabled = this.checked;
            
            if (this.checked && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission !== 'granted') {
                        this.checked = false;
                        notificationsEnabled = false;
                        alert('Please allow notifications in your browser settings');
                    }
                });
            }
        });

        function showNotification(title, body, icon = 'üé•') {
            if (!notificationsEnabled || !('Notification' in window)) {
                return;
            }

            if (Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: icon,
                    badge: icon,
                    tag: 'youtube-downloader',
                    requireInteraction: false
                });

                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };

                // 5Ï¥à ÌõÑ ÏûêÎèô Îã´Í∏∞
                setTimeout(() => notification.close(), 5000);
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showNotification(title, body, icon);
                    }
                });
            }
        }

        // Ìè¨Îß∑ ÏÑ†ÌÉù Ïãú ÌôîÏßà ÏòµÏÖò ÎπÑÌôúÏÑ±Ìôî/ÌôúÏÑ±Ìôî
        document.getElementById('format').addEventListener('change', function() {
            const qualitySelect = document.getElementById('quality');
            if (this.value.startsWith('audio_')) {
                qualitySelect.disabled = true;
                qualitySelect.style.opacity = '0.5';
            } else {
                qualitySelect.disabled = false;
                qualitySelect.style.opacity = '1';
            }
        });

        function formatDuration(seconds) {
            if (!seconds) return '';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }
            return `${minutes}:${String(secs).padStart(2, '0')}`;
        }
        
        function getQualityBadge(quality, format_type) {
            if (format_type === 'audio_mp3') return 'üéµ MP3';
            if (format_type === 'audio_m4a') return 'üéµ M4A';
            
            const badges = {
                'best': '‚≠ê Best',
                '2160p': 'üé¨ 4K',
                '1440p': 'üé¨ 2K',
                '1080p': 'üì∫ 1080p',
                '720p': 'üì∫ 720p',
                '480p': 'üì∫ 480p',
                '360p': 'üì∫ 360p'
            };
            return badges[quality] || quality;
        }

        async function startDownload() {
            const url = document.getElementById('url').value.trim();
            const quality = document.getElementById('quality').value;
            const format_type = document.getElementById('format').value;
            
            if (!url) {
                alert('Please enter a URL');
                return;
            }
            
            const btn = document.querySelector('.input-section button');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Processing...';
            
            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        url: url,
                        quality: quality,
                        format_type: format_type
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.is_playlist) {
                        addPlaylistGroup(data.playlist_id, data.video_ids, data.count, data.thumbnail);
                        
                        data.video_ids.forEach(videoId => {
                            checkStatus(videoId);
                        });
                        
                        checkPlaylistStatus(data.playlist_id);
                        
                        // ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ ÏãúÏûë ÏïåÎ¶º
                        showNotification(
                            'üìã Playlist Download Started',
                            `${data.count} videos added to queue`,
                            'üìã'
                        );
                    } else {
                        addDownloadItem(data.video_id, url, data.thumbnail);
                        checkStatus(data.video_id);
                        
                        // Îã®Ïùº ÎπÑÎîîÏò§ ÏãúÏûë ÏïåÎ¶º
                        showNotification(
                            'üé• Download Started',
                            'Video added to download queue',
                            'üé•'
                        );
                    }
                    
                    document.getElementById('url').value = '';
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function clearInactive() {
            if (!confirm('Clear all completed, cancelled, and error downloads?')) {
                return;
            }
            
            try {
                const response = await fetch('/clear-inactive', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    // ÏÇ≠Ï†úÎêú Ìï≠Î™©Îì§ Ïï†ÎãàÎ©îÏù¥ÏÖòÏúºÎ°ú Ï†úÍ±∞
                    document.querySelectorAll('.download-item.completed, .download-item.cancelled, .download-item.error').forEach(item => {
                        item.style.opacity = '0';
                        item.style.transform = 'translateX(100%)';
                    });
                    
                    document.querySelectorAll('.playlist-group').forEach(group => {
                        const playlistContent = group.querySelector('.playlist-content');
                        const hasActiveItems = playlistContent.querySelector('.download-item.downloading, .download-item.queued');
                        
                        if (!hasActiveItems) {
                            group.style.opacity = '0';
                            group.style.transform = 'translateX(100%)';
                        }
                    });
                    
                    setTimeout(() => {
                        document.querySelectorAll('.download-item.completed, .download-item.cancelled, .download-item.error').forEach(item => {
                            const videoId = item.id.replace('item-', '');
                            if (checkIntervals[videoId]) {
                                clearInterval(checkIntervals[videoId]);
                                delete checkIntervals[videoId];
                            }
                            item.remove();
                        });
                        
                        document.querySelectorAll('.playlist-group').forEach(group => {
                            const playlistContent = group.querySelector('.playlist-content');
                            const hasActiveItems = playlistContent.querySelector('.download-item.downloading, .download-item.queued');
                            
                            if (!hasActiveItems) {
                                const playlistId = group.id.replace('playlist-', '');
                                if (playlistIntervals[playlistId]) {
                                    clearInterval(playlistIntervals[playlistId]);
                                    delete playlistIntervals[playlistId];
                                }
                                group.remove();
                            }
                        });
                        
                        alert(`Cleared ${data.deleted_videos} video(s) and ${data.deleted_playlists} playlist(s)`);
                    }, 300);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function addPlaylistGroup(playlistId, videoIds, count, thumbnail) {
            const downloadsDiv = document.getElementById('downloads');
            const group = document.createElement('div');
            group.className = 'playlist-group';
            group.id = 'playlist-' + playlistId;
            
            const thumbnailHtml = thumbnail 
                ? `<img src="${thumbnail}" alt="Playlist thumbnail" class="playlist-thumbnail">`
                : '<div class="playlist-thumbnail-placeholder">üìã</div>';
            
            group.innerHTML = `
                <div class="playlist-header">
                    ${thumbnailHtml}
                    <div class="playlist-info">
                        <span class="playlist-title" id="playlist-title-${playlistId}">Playlist (${count} videos)</span>
                        <span class="playlist-status" id="playlist-status-${playlistId}">Processing...</span>
                        <span class="playlist-quality" id="playlist-quality-${playlistId}"></span>
                    </div>
                    <div class="playlist-actions">
                        <button class="cancel-playlist-btn" onclick="cancelPlaylist('${playlistId}')">Cancel All</button>
                        <button class="delete-playlist-btn" onclick="deletePlaylist('${playlistId}')" style="display: none;">Delete All</button>
                        <button class="toggle-btn" onclick="togglePlaylist('${playlistId}')">‚ñº</button>
                    </div>
                </div>
                <div class="playlist-content" id="playlist-content-${playlistId}">
                </div>
            `;
            downloadsDiv.insertBefore(group, downloadsDiv.firstChild);
        }
        
        function addDownloadItem(videoId, url, thumbnail) {
            fetch(`/status/${videoId}`)
                .then(res => res.json())
                .then(data => {
                    let container;
                    
                    if (data.playlist_id) {
                        container = document.getElementById('playlist-content-' + data.playlist_id);
                    } else {
                        container = document.getElementById('downloads');
                    }
                    
                    if (!container) return;
                    
                    const item = document.createElement('div');
                    item.className = 'download-item';
                    item.id = 'item-' + videoId;
                    
                    let displayUrl = url;
                    if (data.video_title) {
                        displayUrl = data.video_title;
                    }
                    
                    let playlistBadge = '';
                    if (data.playlist_id) {
                        playlistBadge = `<span class="playlist-badge">${data.playlist_index}/${data.playlist_count}</span>`;
                    }
                    
                    const qualityBadge = `<span class="quality-badge">${getQualityBadge(data.quality, data.format_type)}</span>`;
                    
                    const thumbnailHtml = data.thumbnail || thumbnail
                        ? `<img src="${data.thumbnail || thumbnail}" alt="Video thumbnail" class="video-thumbnail">`
                        : '<div class="video-thumbnail-placeholder">üé¨</div>';
                    
                    const durationHtml = data.duration 
                        ? `<span class="duration">${formatDuration(data.duration)}</span>`
                        : '';
                    
                    item.innerHTML = `
                        <div class="item-content">
                            <div class="thumbnail-container">
                                ${thumbnailHtml}
                                ${durationHtml}
                            </div>
                            <div class="item-details">
                                <div class="item-header">
                                    <div class="url">${playlistBadge}${qualityBadge}${displayUrl}</div>
                                    <div class="action-buttons">
                                        <button class="download-file-btn" id="download-file-${videoId}" onclick="downloadFile('${videoId}')" style="display: none;">‚¨á</button>
                                        <button class="cancel-btn" id="cancel-${videoId}" onclick="cancelDownload('${videoId}')">‚úï</button>
                                        <button class="delete-btn" id="delete-${videoId}" onclick="deleteDownload('${videoId}')" style="display: none;">üóë</button>
                                    </div>
                                </div>
                                <div class="status" id="status-${videoId}">Waiting...</div>
                                <div class="progress-bar">
                                    <div class="progress" id="progress-${videoId}" style="width: 0%">
                                        <span class="progress-text" id="progress-text-${videoId}">0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    if (data.playlist_id) {
                        container.appendChild(item);
                    } else {
                        container.insertBefore(item, container.firstChild);
                    }
                });
        }
        
        function togglePlaylist(playlistId) {
            const content = document.getElementById('playlist-content-' + playlistId);
            const btn = event.target;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                btn.textContent = '‚ñ∂';
            }
        }
        
        async function cancelPlaylist(playlistId) {
            if (!confirm('Cancel all downloads in this playlist?')) {
                return;
            }
            
            try {
                await fetch(`/cancel-playlist/${playlistId}`, { method: 'POST' });
            } catch (error) {
                console.error('Cancel playlist error:', error);
            }
        }
        
        async function deletePlaylist(playlistId) {
            try {
                const response = await fetch(`/delete-playlist/${playlistId}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (response.ok) {
                    const group = document.getElementById('playlist-' + playlistId);
                    group.style.opacity = '0';
                    group.style.transform = 'translateX(100%)';
                    
                    setTimeout(() => {
                        group.remove();
                        clearInterval(playlistIntervals[playlistId]);
                        delete playlistIntervals[playlistId];
                    }, 300);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Delete error: ' + error.message);
            }
        }
        
        async function checkPlaylistStatus(playlistId) {
            let wasAllActive = true;
            
            playlistIntervals[playlistId] = setInterval(async () => {
                try {
                    const response = await fetch(`/playlist-status/${playlistId}`);
                    const data = await response.json();
                    
                    const titleElem = document.getElementById('playlist-title-' + playlistId);
                    const statusElem = document.getElementById('playlist-status-' + playlistId);
                    const qualityElem = document.getElementById('playlist-quality-' + playlistId);
                    const cancelBtn = document.querySelector(`#playlist-${playlistId} .cancel-playlist-btn`);
                    const deleteBtn = document.querySelector(`#playlist-${playlistId} .delete-playlist-btn`);
                    
                    if (titleElem) {
                        titleElem.textContent = `${data.title} (${data.total} videos)`;
                    }
                    
                    if (statusElem) {
                        const s = data.statuses;
                        statusElem.textContent = `‚úì${s.completed} ‚è≥${s.downloading} ‚è∏${s.queued} ‚úï${s.cancelled} ‚úó${s.error}`;
                    }
                    
                    if (qualityElem && data.quality) {
                        qualityElem.textContent = getQualityBadge(data.quality, data.format_type);
                    }
                    
                    const activeCount = data.statuses.downloading + data.statuses.queued;
                    
                    // Î™®Îì† Îã§Ïö¥Î°úÎìúÍ∞Ä ÏôÑÎ£åÎêòÏóàÏùÑ Îïå ÏïåÎ¶º
                    if (wasAllActive && activeCount === 0 && data.statuses.completed > 0) {
                        showNotification(
                            'üìã Playlist Complete',
                            `${data.statuses.completed} video(s) downloaded successfully`,
                            '‚úÖ'
                        );
                    }
                    
                    wasAllActive = activeCount > 0;
                    
                    if (activeCount === 0) {
                        if (cancelBtn) cancelBtn.style.display = 'none';
                        if (deleteBtn) deleteBtn.style.display = 'inline-block';
                        clearInterval(playlistIntervals[playlistId]);
                    }
                } catch (error) {
                    console.error('Playlist status check error:', error);
                }
            }, 1000);
        }
        
        async function cancelDownload(videoId) {
            if (!confirm('Cancel this download?')) {
                return;
            }
            
            try {
                await fetch(`/cancel/${videoId}`, { method: 'POST' });
            } catch (error) {
                console.error('Cancel error:', error);
            }
        }
        
        async function deleteDownload(videoId) {
            try {
                const response = await fetch(`/delete/${videoId}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (response.ok) {
                    const item = document.getElementById('item-' + videoId);
                    item.style.opacity = '0';
                    item.style.transform = 'translateX(100%)';
                    
                    setTimeout(() => {
                        item.remove();
                        clearInterval(checkIntervals[videoId]);
                        delete checkIntervals[videoId];
                    }, 300);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Delete error: ' + error.message);
            }
        }

        async function cleanStorage() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete all downloaded files (except active downloads).\n\nAre you sure?')) {
                return;
            }
            
            if (!confirm('‚ö†Ô∏è FINAL WARNING: Deleted files CANNOT be recovered!\n\nContinue?')) {
                return;
            }
            
            try {
                const response = await fetch('/clean-storage', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ Storage cleaned!\n${data.deleted_count} file(s) deleted.`);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function downloadFile(videoId) {
            window.location.href = `/download-file/${videoId}`;
        }

        function formatSpeed(bytesPerSecond) {
            if (!bytesPerSecond || bytesPerSecond === 0) return '';
            
            const units = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
            let size = bytesPerSecond;
            let unitIndex = 0;
            
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            
            return `${size.toFixed(1)} ${units[unitIndex]}`;
        }
        
        async function checkStatus(videoId) {
            const response = await fetch(`/status/${videoId}`);
            const initialData = await response.json();
            
            if (initialData.playlist_id) {
                let attempts = 0;
                const waitForContainer = setInterval(() => {
                    const container = document.getElementById('playlist-content-' + initialData.playlist_id);
                    if (container || attempts > 10) {
                        clearInterval(waitForContainer);
                        if (!document.getElementById('item-' + videoId)) {
                            addDownloadItem(videoId, initialData.url, initialData.thumbnail);
                        }
                    }
                    attempts++;
                }, 100);
            } else {
                if (!document.getElementById('item-' + videoId)) {
                    addDownloadItem(videoId, initialData.url, initialData.thumbnail);
                }
            }
            
            let lastStatus = null;
            
            checkIntervals[videoId] = setInterval(async () => {
                try {
                    const response = await fetch(`/status/${videoId}`);
                    const data = await response.json();
                    
                    const statusDiv = document.getElementById('status-' + videoId);
                    const progressDiv = document.getElementById('progress-' + videoId);
                    const progressText = document.getElementById('progress-text-' + videoId);
                    const itemDiv = document.getElementById('item-' + videoId);
                    const cancelBtn = document.getElementById('cancel-' + videoId);
                    const deleteBtn = document.getElementById('delete-' + videoId);
                    const downloadFileBtn = document.getElementById('download-file-' + videoId);
                    
                    if (!itemDiv) return;
                    
                    if (data.status === 'queued') {
                        statusDiv.textContent = data.message;
                        itemDiv.className = 'download-item queued';
                        progressDiv.style.width = '0%';
                        progressText.textContent = 'Queued';
                        cancelBtn.style.display = 'inline-block';
                        deleteBtn.style.display = 'none';
                        downloadFileBtn.style.display = 'none';
                    } else if (data.status === 'downloading') {
                        const speedText = data.speed ? ` ‚Ä¢ ${formatSpeed(data.speed)}` : '';
                        statusDiv.textContent = `Downloading...${speedText}`;
                        const progress = data.progress || 0;
                        progressDiv.style.width = progress + '%';
                        progressText.textContent = progress + '%';
                        itemDiv.className = 'download-item downloading';
                        cancelBtn.style.display = 'inline-block';
                        deleteBtn.style.display = 'none';
                        downloadFileBtn.style.display = 'none';
                    } else if (data.status === 'completed') {
                        statusDiv.textContent = `‚úì Completed`;
                        progressDiv.style.width = '100%';
                        progressText.textContent = '100%';
                        itemDiv.className = 'download-item completed';
                        cancelBtn.style.display = 'none';
                        deleteBtn.style.display = 'inline-block';
                        downloadFileBtn.style.display = 'inline-block';
                        
                        // ÏôÑÎ£å ÏïåÎ¶º (Îã®Ïùº ÎπÑÎîîÏò§Îßå, ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏Îäî Ï†ÑÏ≤¥ ÏôÑÎ£å Ïãú ÏïåÎ¶º)
                        if (lastStatus !== 'completed' && !data.playlist_id) {
                            showNotification(
                                '‚úÖ Download Complete',
                                data.video_title || 'Your video is ready',
                                '‚úÖ'
                            );
                        }
                        
                        clearInterval(checkIntervals[videoId]);
                    } else if (data.status === 'cancelled') {
                        statusDiv.textContent = '‚úï Cancelled';
                        itemDiv.className = 'download-item cancelled';
                        cancelBtn.style.display = 'none';
                        deleteBtn.style.display = 'inline-block';
                        downloadFileBtn.style.display = 'none';
                        clearInterval(checkIntervals[videoId]);
                    } else if (data.status === 'error') {
                        statusDiv.textContent = `‚úó Error: ${data.message}`;
                        itemDiv.className = 'download-item error';
                        cancelBtn.style.display = 'none';
                        deleteBtn.style.display = 'inline-block';
                        downloadFileBtn.style.display = 'none';
                        
                        // ÏóêÎü¨ ÏïåÎ¶º
                        if (lastStatus !== 'error') {
                            showNotification(
                                '‚ùå Download Failed',
                                data.video_title || 'Download encountered an error',
                                '‚ùå'
                            );
                        }
                        
                        clearInterval(checkIntervals[videoId]);
                    }
                    
                    lastStatus = data.status;
                    updateActiveCount();
                } catch (error) {
                    console.error('Status check error:', error);
                }
            }, 500);
        }
        
        function updateActiveCount() {
            const downloadingItems = document.querySelectorAll('.download-item.downloading').length;
            document.getElementById('activeCount').textContent = downloadingItems;
        }
        
        document.getElementById('url').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startDownload();
            }
        });
    </script>
</body>
</html>