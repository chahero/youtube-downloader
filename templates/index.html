<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Downloader</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¥ YouTube Downloader</h1>
        
        <div class="input-section">
            <input type="text" id="url" placeholder="Enter YouTube URL">
            <button onclick="startDownload()">Start Download</button>
        </div>
        
        <div class="info">
            Concurrent Downloads: <span id="activeCount">0</span> / {{ max_downloads }}
        </div>
        
        <div id="downloads"></div>
    </div>

    <script>
        let checkIntervals = {};

        async function startDownload() {
            const url = document.getElementById('url').value.trim();
            
            if (!url) {
                alert('Please enter a URL');
                return;
            }
            
            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url: url })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addDownloadItem(data.video_id, url);
                    checkStatus(data.video_id);
                    document.getElementById('url').value = '';
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function addDownloadItem(videoId, url) {
            const downloadsDiv = document.getElementById('downloads');
            const item = document.createElement('div');
            item.className = 'download-item';
            item.id = 'item-' + videoId;
            item.innerHTML = `
                <div class="item-header">
                    <div class="url">${url}</div>
                    <div class="action-buttons">
                        <button class="download-file-btn" id="download-file-${videoId}" onclick="downloadFile('${videoId}')" style="display: none;">â¬‡</button>
                        <button class="cancel-btn" id="cancel-${videoId}" onclick="cancelDownload('${videoId}')">âœ•</button>
                        <button class="delete-btn" id="delete-${videoId}" onclick="deleteDownload('${videoId}')" style="display: none;">ðŸ—‘</button>
                    </div>
                </div>
                <div class="status" id="status-${videoId}">Waiting...</div>
                <div class="progress-bar">
                    <div class="progress" id="progress-${videoId}" style="width: 0%">
                        <span class="progress-text" id="progress-text-${videoId}">0%</span>
                    </div>
                </div>
            `;
            downloadsDiv.insertBefore(item, downloadsDiv.firstChild);
        }
        
        async function cancelDownload(videoId) {
            if (!confirm('Cancel this download?')) {
                return;
            }
            
            try {
                await fetch(`/cancel/${videoId}`, { method: 'POST' });
            } catch (error) {
                console.error('Cancel error:', error);
            }
        }
        
        async function deleteDownload(videoId) {
            try {
                const response = await fetch(`/delete/${videoId}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (response.ok) {
                    const item = document.getElementById('item-' + videoId);
                    item.style.opacity = '0';
                    item.style.transform = 'translateX(100%)';
                    
                    setTimeout(() => {
                        item.remove();
                        clearInterval(checkIntervals[videoId]);
                        delete checkIntervals[videoId];
                    }, 300);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Delete error: ' + error.message);
            }
        }
        
        function downloadFile(videoId) {
            window.location.href = `/download-file/${videoId}`;
        }
        
        async function checkStatus(videoId) {
            checkIntervals[videoId] = setInterval(async () => {
                try {
                    const response = await fetch(`/status/${videoId}`);
                    const data = await response.json();
                    
                    const statusDiv = document.getElementById('status-' + videoId);
                    const progressDiv = document.getElementById('progress-' + videoId);
                    const progressText = document.getElementById('progress-text-' + videoId);
                    const itemDiv = document.getElementById('item-' + videoId);
                    const cancelBtn = document.getElementById('cancel-' + videoId);
                    const deleteBtn = document.getElementById('delete-' + videoId);
                    const downloadFileBtn = document.getElementById('download-file-' + videoId);
                    
                    if (data.status === 'queued') {
                        statusDiv.textContent = data.message;
                        itemDiv.className = 'download-item queued';
                        progressDiv.style.width = '0%';
                        progressText.textContent = 'Queued';
                        cancelBtn.style.display = 'inline-block';
                        deleteBtn.style.display = 'none';
                        downloadFileBtn.style.display = 'none';
                    } else if (data.status === 'downloading') {
                        statusDiv.textContent = 'Downloading...';
                        const progress = data.progress || 0;
                        progressDiv.style.width = progress + '%';
                        progressText.textContent = progress + '%';
                        itemDiv.className = 'download-item downloading';
                        cancelBtn.style.display = 'inline-block';
                        deleteBtn.style.display = 'none';
                        downloadFileBtn.style.display = 'none';
                    } else if (data.status === 'completed') {
                        statusDiv.textContent = `âœ“ Completed: ${data.filename}`;
                        progressDiv.style.width = '100%';
                        progressText.textContent = '100%';
                        itemDiv.className = 'download-item completed';
                        cancelBtn.style.display = 'none';
                        deleteBtn.style.display = 'inline-block';
                        downloadFileBtn.style.display = 'inline-block';
                        clearInterval(checkIntervals[videoId]);
                    } else if (data.status === 'cancelled') {
                        statusDiv.textContent = 'âœ• Cancelled';
                        itemDiv.className = 'download-item cancelled';
                        cancelBtn.style.display = 'none';
                        deleteBtn.style.display = 'inline-block';
                        downloadFileBtn.style.display = 'none';
                        clearInterval(checkIntervals[videoId]);
                    } else if (data.status === 'error') {
                        statusDiv.textContent = `âœ— Error: ${data.message}`;
                        itemDiv.className = 'download-item error';
                        cancelBtn.style.display = 'none';
                        deleteBtn.style.display = 'inline-block';
                        downloadFileBtn.style.display = 'none';
                        clearInterval(checkIntervals[videoId]);
                    }
                    
                    updateActiveCount();
                } catch (error) {
                    console.error('Status check error:', error);
                }
            }, 500);
        }
        
        function updateActiveCount() {
            const downloadingItems = document.querySelectorAll('.download-item.downloading').length;
            document.getElementById('activeCount').textContent = downloadingItems;
        }
        
        document.getElementById('url').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startDownload();
            }
        });
    </script>
</body>
</html>